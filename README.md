# Ad Campaign Delivery System

A Go-based system for managing and delivering ad campaigns based on targeting, consent and budget.

## Quick start
1. Have docker engine running
2. Run the application using make:
   ```bash
   make start
   ```
   The container will be serving in localhost:8080

## Project Overview

This service manages advertising campaigns with features including:
- Campaign creation and management
- Campaign targeting based on OS, country, and device specifications
- Budget management
- Real-time campaign matching and delivery

## Application Architecture

The project follows a hexagonal (ports and adapters) architecture pattern:

```
├── adaptors_in/        # Input adapters (HTTP handlers, cronjobs)
├── adaptors_out/       # Output adapters (storage implementations)
├── app/                # Application configuration
├── core/              # Core/domain business logic
├── model/             # Core/domain models
├── pkg/               # Shared utilities
├── ports_in/          # Input ports (use case interfaces)
└── ports_out/         # Output ports (repository interfaces)
```

## Data Structure

### Campaigns
Campaigns are the main source of information of an ad campaign. 
They are stored in-memory using a key-value structure, indexed by their unique ID.

### Lookup
A secondary campaign lookup structure enables efficient searches by country, device, and OS. 
It stores only minimal campaign data:

- campaign_id
- bid

Once the specific country, device, and OS arrays is found, 
each lookup array is pre-sorted in descending bid order, with earlier entries prioritized in case of bid ties. 
This ensures:
- Higher bids are delivered first.
- Older campaigns win ties.

## Prerequisites
- Docker

## API Endpoints

you can find the swagger documentation in folder `docs/`
Remember to always update the swagger annotations of web methods if implementation changes. 

### Campaigns

- `POST /campaigns` - Create a new campaign
  - Request body includes campaign specifications:
    - id (string)
    - country (string) // 2 characters in upper case
    - device (string)
    - os (string) // operational system
    - bid (decimal)
    - budget (decimal)
    - active_days (integer) //optional
  - Returns 201 status without body on successful creation,
  - Returns 400+ status with formatted error.
  
curl example: 
```curl
curl --location 'http://localhost:8080/campaigns' \
--header 'Content-Type: application/json' \
--data '{
    "id": "camp123",
    "country": "FR",
    "device": "mobile",
    "os": "ios",
    "bid": 2.0,
    "budget": 1000,
    "active_days": 30
}'
```

- `POST /deliver` - Retrieves the best matching campaign according to informed parameter
  - Header `X-Consent-String` should be a TCF v2 format string
  - Request body includes campaign specifications:
    - country (string) // 2 characters in upper case
    - device (string)
    - os (string) // operational system
  - Returns 200 status when a campaign match is found with id and bid,
  - Returns 204 when no campaign was found,
  - Returns 400+ status with formatted error.

The bid value will be deducted from the budget of the campaign.

OBS: At the moment, the code is considering as authorized the TCF token with personalized ads values 1 and 4 and vendor 1231.
  - curl example with authorized token:
```curl
curl --location 'http://localhost:8080/deliver' \
--header 'X-Consent-String: CQMGLkAQMGLkABcAKEFRBbFgAP_gAEPgAAqIJnkR_C9MQWFjcT51AfskaYxHxgACoEQgBACJgygBCAPA8IQEwGAYIAxAAqAKAAAAoiRBAAAlCAhQAAAAQAAAACCMAEAAAAAAIKBAgAARAgEACAhBGQAAEAAAAIBBABAAgAAEQBoAQBAAAAAAAAAgAAAgAACBAAAIAAAAAAEAAAAIAEgAAAAAAAAAAAAAAlAIAAAIAAAAAAAAAAAIJngAmChEQAFgQAhAAGEECABQRgAAAAAgAACBggAACAAA4AQAUGAAAAAAAAAIAAAAggABAAABAAhAAAAAQAAAAAAIAAAAAAAAACBAAAABAAAAAAgAAQAAAAAAAABAABAAgAAAABAAQBAAAAAgAAAAAAAAAACAAAAAAAAAAAEAAAAIAEAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAA' \
--header 'Content-Type: application/json' \
--data '{
    "country": "FR",
    "device": "mobile",
    "os": "ios"
}'
```

## Cronjob
Cronjob that deactivates campaigns if their validation expired. 
This cron runs every day at 00:01pm

## Development
- Docker container is running with Air to enable live updates
- Interface mocks (for tests) can be generated by running the `/matryer/mock` described over the interface.
  - In case of error, delete the mock and try to run it again. 
- command `make generate` should update the swagger documentation



### Running Tests

Run `make docker/test` to run all the tests in a docker container.
The container will be removed once the test finishes.

